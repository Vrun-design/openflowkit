"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const N=require("reactflow"),B={stroke:"#94a3b8",strokeWidth:2},W={fill:"#334155",fontWeight:500,fontSize:12},v={fill:"#ffffff",stroke:"#cbd5e1",strokeWidth:1},C={type:"smoothstep",markerEnd:{type:N.MarkerType.ArrowClosed},animated:!0,style:B,labelStyle:W,labelBgStyle:v,labelBgPadding:[8,4],labelBgBorderRadius:4},x=(r,e,s,l)=>({id:l||`e-${r}-${e}-${Date.now()}`,source:r,target:e,label:s,...C}),O={start:{color:"emerald",icon:"none",shape:"capsule"},end:{color:"red",icon:"none",shape:"capsule"},decision:{color:"amber",icon:"none",shape:"diamond"},custom:{color:"violet",icon:"none",shape:"rounded"},process:{color:"slate",icon:"none",shape:"rounded"}},P=r=>{var e;return((e=O[r])==null?void 0:e.color)||"slate"},z=[{open:"([",close:"])",type:"start",shape:"capsule"},{open:"((",close:"))",type:"end",shape:"circle"},{open:"{{",close:"}}",type:"custom",shape:"hexagon"},{open:"[(",close:")]",type:"process",shape:"cylinder"},{open:"{",close:"}",type:"decision",shape:"diamond"},{open:"[",close:"]",type:"process",shape:"rounded"},{open:"(",close:")",type:"process",shape:"rounded"},{open:">",close:"]",type:"process",shape:"parallelogram"}],G=[/^%%/,/^class\s/i,/^click\s/i,/^direction\s/i,/^accTitle\s/i,/^accDescr\s/i],F=/^linkStyle\s+([\d,\s]+)\s+(.+)$/i,Y=/^classDef\s+(\w+)\s+(.+)$/i,U=/^style\s+(\w+)\s+(.+)$/i;function j(r){const e=r.match(F);if(!e)return null;const s=e[1].split(",").map(i=>parseInt(i.trim(),10)).filter(i=>!isNaN(i)),l=e[2].replace(/;$/,"").split(","),f={};for(const i of l){const[g,y]=i.split(":").map(p=>p.trim());g&&y&&(f[g]=y)}return{indices:s,style:f}}function K(r){let e="",s=!1;for(let l=0;l<r.length;l++){const f=r[l];if(f==='"'&&r[l-1]!=="\\"&&(s=!s),s&&f===`
`){e+="\\n";let i=l+1;for(;i<r.length&&(r[i]===" "||r[i]==="	");)i++;l=i-1}else e+=f}return e}function Z(r){let e=r;return e=e.replace(/==(?![>])\s*(.+?)\s*==>/g," ==>|$1|"),e=e.replace(/--(?![>-])\s*(.+?)\s*-->/g," -->|$1|"),e=e.replace(/-\.\s*(.+?)\s*\.->/g," -.->|$1|"),e=e.replace(/--(?![>-])\s*(.+?)\s*---/g," ---|$1|"),e}function q(r){const e=r.replace(/fa:fa-[\w-]+\s*/g,"").trim();if(e)return e;const s=r.match(/fa:fa-([\w-]+)/);return s?s[1].replace(/-/g," "):r}function H(r,e){const s=r.indexOf(e.open);if(s<1||s>0&&r[s-1]===e.open[0])return null;const l=r.substring(0,s).trim();if(!/^[a-zA-Z0-9_][\w-]*$/.test(l))return null;const f=r.substring(s+e.open.length),i=f.lastIndexOf(e.close);if(i<0)return null;const g=f.substring(i+e.close.length).trim();let y=[];if(g.startsWith(":::"))y=g.substring(3).split(/,\s*/);else if(g)return null;let p=f.substring(0,i).trim();return(p.startsWith('"')&&p.endsWith('"')||p.startsWith("'")&&p.endsWith("'"))&&(p=p.slice(1,-1)),p=p.replace(/\\n/g,`
`),p=q(p),p||(p=l),{id:l,label:p,type:e.type,shape:e.shape,classes:y.length?y:void 0}}function _(r){const e=r.trim();if(!e)return null;for(const f of z){const i=H(e,f);if(i)return i}let s=e,l=[];if(s.includes(":::")){const f=s.split(":::");s=f[0],l=f[1].split(/,\s*/)}return/^[a-zA-Z0-9_][\w-]*$/.test(s)?{id:s,label:s,type:"process",classes:l.length?l:void 0}:null}const $=["===>","-.->","--->","-->","===","---","==>","-.-","--"];function I(r){for(const e of $){const s=r.indexOf(e);if(s>=0)return{arrow:e,before:r.substring(0,s).trim(),after:r.substring(s+e.length).trim()}}return null}function Q(r){const e=[];let s=r,l=null;for(;s.trim();){const f=I(s);if(!f)break;const{arrow:i,before:g,after:y}=f,p=l||g;let m="",E=y;const b=E.match(/^\|"?([^"|]*)"?\|\s*/);b&&(m=b[1].trim(),E=E.substring(b[0].length));const L=I(E);let D;L?(D=L.before,s=E):(D=E,s="");let T=p.trim(),t=D.trim();if(T.includes(":::")&&(T=T.split(":::")[0]),t.includes(":::")&&(t=t.split(":::")[0]),T&&t&&e.push({sourceRaw:T,targetRaw:t,label:m,arrowType:i}),l=D.trim(),!L)break}return e}function A(r){const e={},s=r.split(",");for(const l of s){const[f,i]=l.split(":").map(g=>g.trim());f&&i&&(e[f]=i.replace(/;$/,""))}return e}const J=r=>{var T;let e=r.replace(/\r\n/g,`
`);e=K(e),e=Z(e);const s=e.split(`
`),l=new Map,f=[],i=new Map,g=new Map;let y="TB",p="unknown";const m=[];let E=0;const b=(t,c="process",o)=>{let n=_(t),d=t;if(t==="[*]")d=`state_start_${E++}`,n={id:d,label:"Start/End",type:"start",shape:"circle"};else if(!n)if(d=t.trim(),d.includes(":::")){const M=d.split(":::");d=M[0],n={id:d,label:d,type:"process",classes:M[1].split(/,\s*/)}}else n={id:d,label:d,type:c};const h=l.get(n.id),S=m.length>0?m[m.length-1]:void 0;return h?(n.label!==n.id&&(h.label=n.label),n.type!=="process"&&(h.type=n.type),n.shape&&(h.shape=n.shape),n.classes&&(h.classes=[...h.classes||[],...n.classes]),!h.parentId&&S&&(h.parentId=S)):l.set(n.id,{...n,parentId:S}),o&&l.has(n.id)&&(l.get(n.id).label=o),n.id};for(let t=0;t<s.length;t++){const c=s[t].trim();if(!c||G.some(a=>a.test(c)))continue;if(c.match(/^(?:flowchart|graph)\s+(TD|TB|LR|RL|BT)/i)){p="flowchart";const a=c.match(/^(?:flowchart|graph)\s+(TD|TB|LR|RL|BT)/i);a&&(y=a[1].toUpperCase()),y==="TD"&&(y="TB");continue}if(c.match(/^stateDiagram(?:-v2)?/i)){p="stateDiagram";const a=(T=s[t+1])==null?void 0:T.trim().match(/^direction\s+(LR|TB)/i);a&&(y=a[1].toUpperCase());continue}const o=c.match(/^subgraph\s+([\[\]\w\s"'-]+)/i),n=c.match(/^state\s+"([^"]+)"\s+as\s+(\w+)\s+\{/i)||c.match(/^state\s+(\w+)\s+\{/i);if(o){let a=o[1].trim(),u=a,k=a;const w=a.match(/^(\w+)\s*\[(.+)\]$/);w?(u=w[1],k=w[2]):u=a.replace(/\s+/g,"_"),l.set(u,{id:u,label:k,type:"group",parentId:m[m.length-1]}),m.push(u);continue}if(n){let a=n[2]||n[1],u=n[1];l.set(a,{id:a,label:u,type:"group",parentId:m[m.length-1]}),m.push(a);continue}if(c.match(/^end\s*$/i)){m.pop();continue}const d=c.match(Y);if(d){const a=d[1],u=d[2];g.set(a,A(u));continue}const h=c.match(U);if(h){const a=h[1],u=h[2],k=A(u),w=l.get(a);if(w)w.styles={...w.styles,...k};else{b(a);const R=l.get(a);R&&(R.styles=k)}continue}const S=j(c);if(S){S.indices.forEach(a=>i.set(a,S.style));continue}if($.some(a=>c.includes(a))){const a=Q(c);for(const u of a){const k=b(u.sourceRaw,p==="stateDiagram"?"state":"process"),w=b(u.targetRaw,p==="stateDiagram"?"state":"process");k&&w&&f.push({source:k,target:w,label:u.label,arrowType:u.arrowType})}continue}if(p==="stateDiagram"){const a=c.match(/^state\s+"([^"]+)"\s+as\s+(\w+)/i);if(a){b(a[2],"state",a[1]);continue}const u=c.match(/^(\w+)\s*:\s*(.+)/);if(u){b(u[1],"state",u[2]);continue}}_(c)&&b(c)}if(p==="unknown")return{nodes:[],edges:[],error:'Missing chart type declaration. Start with "flowchart TD" or related.'};if(l.size===0)return{nodes:[],edges:[],error:"No valid nodes found."};const L=Array.from(l.values()).map((t,c)=>{let o={id:t.id,type:t.type,position:{x:c%4*200,y:Math.floor(c/4)*150},data:{label:t.label,subLabel:"",color:P(t.type),...t.shape?{shape:t.shape}:{}}};return t.parentId&&(o.parentNode=t.parentId,o.extent="parent"),t.type==="group"&&(o.className="bg-slate-50/50 border-2 border-dashed border-slate-300 rounded-lg",o.style={width:600,height:400}),t.classes&&t.classes.forEach(n=>{const d=g.get(n);d&&(d.fill&&(o.style={...o.style,backgroundColor:d.fill}),d.stroke&&(o.style={...o.style,borderColor:d.stroke}),d.color&&(o.style={...o.style,color:d.color}))}),t.styles&&(t.styles.fill&&(o.style={...o.style,backgroundColor:t.styles.fill}),t.styles.stroke&&(o.style={...o.style,borderColor:t.styles.stroke}),t.styles.color&&(o.style={...o.style,color:t.styles.color})),p==="stateDiagram"&&(t.type==="start"&&(o.style={...o.style,width:20,height:20,borderRadius:"50%",backgroundColor:"#000"},o.data.label=""),t.type==="state"&&(o.data.shape="rounded")),o}),D=f.map((t,c)=>{const o=x(t.source,t.target,t.label||void 0,`e-mermaid-${c}`);(t.arrowType.includes("-.")||t.arrowType.includes("-.-"))&&(o.style={...o.style,strokeDasharray:"5 3"}),t.arrowType.includes("==")&&(o.style={...o.style,strokeWidth:4}),t.arrowType.includes(">")||(o.markerEnd=void 0);const n=i.get(c);if(n){const d=n.stroke;d&&(o.style={...o.style,stroke:d});const h=n["stroke-width"];h&&(o.style={...o.style,strokeWidth:parseInt(h,10)||2})}return o});return{nodes:L,edges:D,direction:y}};exports.parseMermaid=J;
